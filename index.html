<!DOCTYPE html>
<html>
<head>
  <title>Inventory Checkout Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    .product-group {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    .autocomplete-results {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 99;
      max-height: 150px;
      overflow-y: auto;
      width: 90%;
      left: 0;
      top: 68px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .autocomplete-result {
      padding: 6px 10px;
      cursor: pointer;
    }
    .autocomplete-result:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <h2>Inventory Checkout Form</h2>
  <form id="checkout-form" autocomplete="off">
    <div id="product-list"></div>

    <button type="button" onclick="addProduct()">Add Product</button>
    <br><br>

    <label>Location:
      <select name="location" required>
        <option value="Trailer">Trailer</option>
        <option value="Warehouse">Warehouse</option>
        <option value="Alec">Alec</option>
        <option value="Master">Master</option>
      </select>
    </label>

    <label>Job / Customer Name:
      <input type="text" name="customer" required>
    </label>

    <label>Technician Name:
      <input type="text" name="technician" required>
    </label>

    <br>
    <button type="submit">Submit</button>
  </form>

  <script>
    const products = [
      "4004876-9 Local CANBUS Ext 9 ft",
      "4004876-2 Local CANBUS Ext 2 ft",
      "4004876-12 Local CANBUS Ext 12 ft",
      "4006167 PCM2 I/O Cable",
      "4005945 RCM2 Row to Row Harness",
      "4006224 RCM2 Surespeed cable",
      "4001450-12 High Current Power Extension 12ft",
      "BR1 Mini Mounting"
    ];

    let productCount = 0;
    const maxProducts = 10;

    function createAutocompleteInput(idx) {
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";
      wrapper.innerHTML = `
        <label>Part # / Product Name:
          <input type="text" name="product${idx}" required autocomplete="off" style="width: 90%;">
          <div class="autocomplete-results" style="display:none;"></div>
        </label>
      `;
      const input = wrapper.querySelector("input");
      const results = wrapper.querySelector(".autocomplete-results");

      input.addEventListener("input", function() {
        const val = input.value.trim().toLowerCase();
        if (!val) {
          results.style.display = "none";
          results.innerHTML = "";
          return;
        }
        const matches = products.filter(p => p.toLowerCase().includes(val)).slice(0, 10);
        if (!matches.length) {
          results.style.display = "none";
          results.innerHTML = "";
          return;
        }
        results.innerHTML = matches.map(m => `<div class="autocomplete-result">${m}</div>`).join("");
        results.style.display = "block";
      });

      // Click to select
      results.addEventListener("mousedown", function(e) {
        if (e.target.classList.contains("autocomplete-result")) {
          input.value = e.target.textContent;
          results.style.display = "none";
          results.innerHTML = "";
        }
      });

      // Hide on blur
      input.addEventListener("blur", function() {
        setTimeout(() => {
          results.style.display = "none";
        }, 200);
      });

      return wrapper;
    }

    function addProduct() {
      if (productCount >= maxProducts) {
        alert("Max 10 products allowed");
        return;
      }
      const div = document.createElement("div");
      div.className = "product-group";
      // Add search bar
      div.appendChild(createAutocompleteInput(productCount));
      // Add qty
      const qtyLabel = document.createElement("label");
      qtyLabel.innerHTML = `Quantity:
        <select name="qty${productCount}" required>
          ${[...Array(10)].map((_, i) => `<option>${i + 1}</option>`).join('')}
        </select>`;
      div.appendChild(qtyLabel);

      document.getElementById("product-list").appendChild(div);
      productCount++;
    }

    // Initial product row
    addProduct();

    document.getElementById("checkout-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      const payload = {
        timestamp: new Date().toISOString(),
        location: data.get("location"),
        customer: data.get("customer"),
        technician: data.get("technician"),
        products: []
      };

      for (let i = 0; i < productCount; i++) {
        const name = data.get(`product${i}`);
        const qty = data.get(`qty${i}`);
        if (name && qty) {
          payload.products.push({ name, qty });
        }
      }

      // Call your Apps Script Web App endpoint here
      try {
        await fetch("https://script.google.com/macros/s/AKfycbzfkv59TACVtAjWJ5lOtK-slFHxIreP4Yd5fx2iKmXGJo97i9ELm2_e4PMVk3UxiJDf/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        alert("Submission sent!");
        form.reset();
        document.getElementById("product-list").innerHTML = "";
        productCount = 0;
        addProduct();
      } catch (err) {
        alert("Submission failed.");
      }
    });
  </script>
</body>
</html>
